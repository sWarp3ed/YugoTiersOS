<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yugo OPS</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      background-image: url("https://picfiles.alphacoders.com/478/478314.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      margin: 0;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      color: #ccc;
    }

    #addplayer-button {
      position: absolute;
      top: 20px;
      left: 400px;
      background-color: greenyellow;
      border-radius: 10px;
      height: 60px;
      width: 65px;
      cursor: pointer;
    }

    #player-list {
      margin-top: 70px;
      margin-left: 10px;
      max-width: 400px;
      height: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 320px;
    }

    .player-link {
      text-decoration: none;
      color: #ffffff;
      background-color: #1f1f1f;
      padding: 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
      font-size: 20px;
      cursor: pointer;
      flex: 1;
    }

    .player-link:hover {
      background-color: #2c2c2c;
    }

    #search-bar {
      position: absolute;
      top: 20px;
      left: 35px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      background-color: #1e1e1e;
      color: white;
      font-size: 17px;
      width: 300px;
      height: 40px;
      transition: width 0.3s ease;
      margin-bottom: 20px;
    }

    #search-bar:hover {
      width: 330px;
    }

    #modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #modal {
      background-color: #1f1f1f;
      padding: 20px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 300px;
    }

    #modal input {
      padding: 10px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
    }

    #done-button, #cancel-button {
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }

    #done-button {
      background-color: #03dac5;
      color: black;
    }

    #cancel-button {
      background-color: #cf6679;
      color: black;
    }

    /* Profile on the right */
    #player-profile {
      position: fixed;
      top: 70px;
      right: 200px;
      width: 1000px;
      height: 700px;
      background-color: #1f1f1f;
      border-radius: 8px;
      padding: 20px;
      display: none;
      flex-direction: column;
      gap: 12px;
      font-size: 24px;
      color: white;
      opacity: 0.9;
      text-align: left;
      overflow-y: auto;
    }

    .tier-entry {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .tier-entry input {
      flex: 1;
      padding: 6px;
      border-radius: 4px;
      border: none;
      font-size: 18px;
    }

    .tier-entry select {
      padding: 6px;
      font-size: 16px;
    }

    .tier-entry button {
      background-color: #cf6679;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      color: black;
      font-size: 20px;
    }

    #player-profile h2 {
      margin-top: 0;
      font-size: 36px;
    }

    #profile-placement, #profile-points {
      font-size: 20px;
      line-height: 1.2;
    }

    #profile-name {
      margin-bottom: 5px;
    }

    #profile-skin {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 160px;
      height: 160px;
      border-radius: 10px;
      border: 4px solid #464646;
    }

    .kit-icon {
      width: 40px;
      height: 40px;
      margin-left: 50px;
      cursor: pointer;
      filter: brightness(0.8);
      transition: filter 0.2s;
    }

    .kit-icon:hover {
      filter: brightness(1);
    }

    #kit-panel {
      display: none;
      position: fixed;
      bottom: 175px;
      right: 250px;
      background-color: #2e2e2e;
      border-radius: 12px;
      padding: 20px;
      width: 900px;
      height: 260px;
      color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      z-index: 9999;
      opacity: 0.95;
    }

    #tier-buttons {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    #tier-buttons button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      background-color: #f0f0f0;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s ease;
      font-weight: bold;
      font-size: 16px;
    }

    #tier-buttons button:hover {
      background-color: #e0e0e0;
    }

    #tier-buttons button.selected {
      background-color: #00cc99;
      color: white;
      border-color: #00b386;
    }

    #kit-panel h2 {
      margin: 0;
      font-size: 28px;
    }

    /* Scrollbar for tiers */
    #profile-tiers {
      max-height: 400px;
      overflow-y: auto;
      margin-left: 50px;
    }
  </style>
</head>
<body>
  <input id="search-bar" placeholder="Search players..." />
  <img src="addplayer.webp" id="addplayer-button" alt="Add Player" />

  <div id="player-list"></div>

  <!-- Add Player Modal -->
  <div id="modal-overlay">
    <div id="modal">
      <input id="player-name-input" placeholder="Enter player name" />
      <button id="done-button">Add</button>
      <button id="cancel-button">Cancel</button>
    </div>
  </div>

  <!-- Player Profile Panel -->
  <div id="player-profile">
    <img id="profile-skin" alt="Player Skin" />
    <h2 id="profile-name">Player Name</h2>
    <h3 id="profile-placement"></h3>
    <h4 id="profile-points"></h4>
    <div id="profile-tiers"></div>

    <div>
      <img src="https://mctiers.com/tier_icons/vanilla.svg" class="kit-icon" title="Crystal" onclick="openKitSettings('CRYSTALS')" />
      <img src="https://mctiers.com/tier_icons/axe.svg" class="kit-icon" title="Axe" onclick="openKitSettings('AXE')" />
      <img src="https://mctiers.com/tier_icons/sword.svg" class="kit-icon" title="Sword" onclick="openKitSettings('SWORD')" />
      <img src="https://mctiers.com/tier_icons/bow.svg" class="kit-icon" title="Bow" onclick="openKitSettings('BOW')" />
      <img src="https://mctiers.com/tier_icons/archer.svg" class="kit-icon" title="Archer" onclick="openKitSettings('ARCHER')" />
      <img src="https://mctiers.com/tier_icons/pot.svg" class="kit-icon" title="Pot" onclick="openKitSettings('POT')" />
    </div>
  </div>

  <!-- Kit Tier Selection Panel -->
  <div id="kit-panel">
    <h2 id="kit-panel-title"></h2>
    <div id="tier-buttons"></div>
  </div>

  <script>
    // Firebase config - insert your own config here!
    const firebaseConfig = {
      apiKey: "AIzaSyCXixxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
      authDomain: "yugo-ops.firebaseapp.com",
      projectId: "yugo-ops",
      storageBucket: "yugo-ops.appspot.com",
      messagingSenderId: "xxxxxxxxxxxx",
      appId: "1:xxxxxxxxxxxx:web:xxxxxxxxxxxxxxx",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const playerListEl = document.getElementById("player-list");
    const addPlayerBtn = document.getElementById("addplayer-button");
    const modalOverlay = document.getElementById("modal-overlay");
    const playerNameInput = document.getElementById("player-name-input");
    const doneButton = document.getElementById("done-button");
    const cancelButton = document.getElementById("cancel-button");
    const searchBar = document.getElementById("search-bar");

    const playerProfile = document.getElementById("player-profile");
    const profileName = document.getElementById("profile-name");
    const profilePlacement = document.getElementById("profile-placement");
    const profilePoints = document.getElementById("profile-points");
    const profileTiers = document.getElementById("profile-tiers");
    const profileSkin = document.getElementById("profile-skin");

    const kitPanel = document.getElementById("kit-panel");
    const kitPanelTitle = document.getElementById("kit-panel-title");
    const tierButtonsDiv = document.getElementById("tier-buttons");

    // Global state
    let players = [];
    let currentPlayer = null;
    let currentEditingTierIndex = null;
    let currentEditingKit = null;

    // Tier options for kits
    const kits = {
      CRYSTALS: ["HT1", "HT2", "HT3", "HT4", "HT5", "LT1", "LT2", "LT3", "LT4", "LT5"],
      AXE: ["A1", "A2", "A3", "A4", "A5"],
      SWORD: ["S1", "S2", "S3", "S4", "S5"],
      BOW: ["B1", "B2", "B3", "B4", "B5"],
      ARCHER: ["AR1", "AR2", "AR3", "AR4", "AR5"],
      POT: ["P1", "P2", "P3", "P4", "P5"],
    };

    // Load players from Firestore
    function loadPlayers() {
      db.collection("players").get().then((querySnapshot) => {
        players = [];
        querySnapshot.forEach((doc) => {
          let data = doc.data();
          data.id = doc.id;
          players.push(data);
        });
        renderPlayerList(players);
      });
    }

    // Render player list in sidebar, filtered by optional search text
    function renderPlayerList(playersToRender) {
      playerListEl.innerHTML = "";
      playersToRender.forEach(player => {
        const a = document.createElement("a");
        a.textContent = player.name;
        a.classList.add("player-link");
        a.href = "#";
        a.onclick = (e) => {
          e.preventDefault();
          openPlayerProfile(player.id);
        };
        playerListEl.appendChild(a);
      });
    }

    // Search players and filter list
    searchBar.addEventListener("input", () => {
      const term = searchBar.value.toLowerCase();
      const filtered = players.filter(p => p.name.toLowerCase().includes(term));
      renderPlayerList(filtered);
    });

    // Add player modal controls
    addPlayerBtn.onclick = () => {
      playerNameInput.value = "";
      modalOverlay.style.display = "flex";
      playerNameInput.focus();
    };

    doneButton.onclick = async () => {
      const name = playerNameInput.value.trim();
      if (!name) {
        alert("Please enter a player name");
        return;
      }
      // Add new player with empty tiers array
      const newPlayer = {
        name,
        tiers: []
      };
      try {
        const docRef = await db.collection("players").add(newPlayer);
        newPlayer.id = docRef.id;
        players.push(newPlayer);
        renderPlayerList(players);
        modalOverlay.style.display = "none";
      } catch (e) {
        alert("Error adding player: " + e.message);
      }
    };

    cancelButton.onclick = () => {
      modalOverlay.style.display = "none";
    };

    modalOverlay.onclick = (e) => {
      if (e.target === modalOverlay) {
        modalOverlay.style.display = "none";
      }
    };

    // Open player profile and show tiers, skin etc
    async function openPlayerProfile(playerId) {
      currentPlayer = players.find(p => p.id === playerId);
      if (!currentPlayer) return;

      profileName.textContent = currentPlayer.name;

      // Load skin image from crafatar
      profileSkin.src = `https://crafatar.com/avatars/${currentPlayer.name}?size=160&overlay`;

      // Calculate placement and points (example logic, replace as needed)
      // For demo, show count of tiers as points and 1st place if name is first alphabetically
      const sortedPlayers = [...players].sort((a,b) => a.name.localeCompare(b.name));
      const placement = sortedPlayers.findIndex(p => p.id === playerId) + 1;
      profilePlacement.textContent = `Placement: ${placement}`;
      profilePoints.textContent = `Points: ${currentPlayer.tiers.length}`;

      renderTiers();

      playerProfile.style.display = "flex";
      kitPanel.style.display = "none";
    }

    // Render tiers in profile
    function renderTiers() {
      profileTiers.innerHTML = "";

      if (!currentPlayer.tiers) {
        currentPlayer.tiers = [];
      }

      currentPlayer.tiers.forEach((tierObj, idx) => {
        const div = document.createElement("div");
        div.classList.add("tier-entry");

        // Tier text input
        const tierInput = document.createElement("input");
        tierInput.value = tierObj.tier || "";
        tierInput.placeholder = "Tier (e.g. HT1)";
        tierInput.disabled = true;
        div.appendChild(tierInput);

        // Kit selection dropdown
        const kitSelect = document.createElement("select");
        for (const kitName in kits) {
          const option = document.createElement("option");
          option.value = kitName;
          option.textContent = kitName;
          if (tierObj.kit === kitName) option.selected = true;
          kitSelect.appendChild(option);
        }
        kitSelect.disabled = true;
        div.appendChild(kitSelect);

        // Edit button to enable editing
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.onclick = () => {
          tierInput.disabled = false;
          kitSelect.disabled = false;
          tierInput.focus();
          editBtn.style.display = "none";
          saveBtn.style.display = "inline-block";
          cancelBtn.style.display = "inline-block";
        };
        div.appendChild(editBtn);

        // Save button
        const saveBtn = document.createElement("button");
        saveBtn.textContent = "Save";
        saveBtn.style.display = "none";
        saveBtn.onclick = () => {
          const newTier = tierInput.value.trim();
          const newKit = kitSelect.value;
          if (!newTier) {
            alert("Tier cannot be empty");
            return;
          }
          currentPlayer.tiers[idx] = { tier: newTier, kit: newKit };
          savePlayerTiers();
          renderTiers();
        };
        div.appendChild(saveBtn);

        // Cancel button
        const cancelBtn = document.createElement("button");
        cancelBtn.textContent = "Cancel";
        cancelBtn.style.display = "none";
        cancelBtn.onclick = () => {
          renderTiers();
        };
        div.appendChild(cancelBtn);

        // Delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "X";
        deleteBtn.title = "Delete this tier";
        deleteBtn.onclick = () => {
          if (confirm("Delete this tier?")) {
            currentPlayer.tiers.splice(idx, 1);
            savePlayerTiers();
            renderTiers();
          }
        };
        div.appendChild(deleteBtn);

        profileTiers.appendChild(div);
      });

      // Add new tier button
      const addTierBtn = document.createElement("button");
      addTierBtn.textContent = "Add Tier";
      addTierBtn.style.marginTop = "10px";
      addTierBtn.onclick = () => {
        // Add empty tier and open kit panel for first tier
        currentPlayer.tiers.push({ tier: "", kit: "CRYSTALS" });
        currentEditingTierIndex = currentPlayer.tiers.length - 1;
        openKitSettings("CRYSTALS");
        renderTiers();
      };
      profileTiers.appendChild(addTierBtn);
    }

    // Save player's tiers back to Firestore
    async function savePlayerTiers() {
      if (!currentPlayer) return;
      try {
        await db.collection("players").doc(currentPlayer.id).update({
          tiers: currentPlayer.tiers
        });
        // Update local player list data as well
        const idx = players.findIndex(p => p.id === currentPlayer.id);
        if (idx !== -1) {
          players[idx].tiers = currentPlayer.tiers;
        }
      } catch (e) {
        alert("Error saving tiers: " + e.message);
      }
    }

    // Kit panel open/close and tier selection logic
    function openKitSettings(kitName) {
      if (!currentPlayer) return;
      currentEditingKit = kitName;
      kitPanelTitle.textContent = `Select tier for kit: ${kitName}`;
      kitPanel.style.display = "block";

      // Clear previous buttons
      tierButtonsDiv.innerHTML = "";

      // Get tiers for this kit
      const kitTierOptions = kits[kitName];
      if (!kitTierOptions) return;

      // Determine currently selected tier for this kit in current editing tier index
      let selectedTier = null;
      if (
        currentEditingTierIndex !== null &&
        currentPlayer.tiers[currentEditingTierIndex] &&
        currentPlayer.tiers[currentEditingTierIndex].kit === kitName
      ) {
        selectedTier = currentPlayer.tiers[currentEditingTierIndex].tier;
      }

      kitTierOptions.forEach(tier => {
        const btn = document.createElement("button");
        btn.textContent = tier;
        if (tier === selectedTier) btn.classList.add("selected");
        btn.onclick = () => {
          // Update the tier and kit for the editing tier index
          if (currentEditingTierIndex !== null) {
            currentPlayer.tiers[currentEditingTierIndex] = {
              tier: tier,
              kit: kitName,
            };
            savePlayerTiers();
            renderTiers();
            kitPanel.style.display = "none";
          }
        };
        tierButtonsDiv.appendChild(btn);
      });
    }

    // Close kit panel if clicked outside
    document.addEventListener("click", (e) => {
      if (!kitPanel.contains(e.target) && !e.target.classList.contains("kit-icon")) {
        kitPanel.style.display = "none";
      }
    });

    // Initial load
    loadPlayers();
  </script>
</body>
</html>